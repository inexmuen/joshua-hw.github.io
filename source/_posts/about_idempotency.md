---
title: 关于幂等
date: 2017-01-10 15:00:00
author: Fanteathy
tags: arch
categories: arch
---

## 幂等方案

### 可以保证幂等的操作

#### 1. 查询操作

查询一次和查询多次，在数据不变的情况下，查询结果是一样的。在隔离级别为可重复读(mysql默认隔离级别)时，select是天然的幂等操作

#### 2. 删除操作

删除操作也是幂等的，删除一次和多次删除结果相同，都是把数据删除。(注意可能返回结果不一样，删除的数据不存在，返回0；删除的数据多条，返回结果多个)

#### 3. 唯一索引

唯一索引或唯一组合索引来防止提交重复数据，不过对DB性能有影响

#### 4. 悲观锁

获取数据的时候加锁获取

```	
select * from table_xxx where id='xxx' for update;
```

#### 5. 乐观锁

乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。

乐观锁的实现方式多种多样，可以通过version或者其他状态条件：

- 通过版本号实现

```
update table_xxx set name=#name#,version=version+1 where id=#id# and version=#version# 
```

- 通过条件限制

```
update table_xxx set total=total-#hongbao# where id=#id# and total-#hongbao# > 0
```

#### 6. 分布式锁

如果是分布式系统，构建全局唯一索引比较困难，例如唯一性的字段没法确定，这时候可以引入分布式锁，通过第三方的系统(redis或zookeeper)，在业务系统插入数据或者更新数据，获取分布式锁，然后做操作，之后释放锁。

或者在执行接口的逻辑前，先在mysql表中插入接口的特征值(此字段设置unique)，用mysql保证对应的业务逻辑只执行一次。

分布式锁的java实现及使用: 

[https://github.com/redisson/redisson](https://github.com/redisson/redisson)

[https://my.oschina.net/wangnian/blog/668830](https://my.oschina.net/wangnian/blog/668830)

#### 7. 状态机幂等

状态在不同的情况下会发生变更，一般情况下存在有限状态机(fsm)，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。

伪代码如下:

```
// 如果状态已经发生变更，直接return
if fsm.status = expected_status:
	return
```

### ***不推荐的方案***

#### 1. select + insert

并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，再进行业务处理。***这种方法在高并发时会出现问题***

## 几条基本原则

- ***DB不能DOWN，DB不能DOWN，DB不能DOWN***

***这是最重要的前提***。不管是使用连接池，使用缓存，使用搜索，还是DAL的限流。所有这些措施的最重要作用首先都是为了保证数据库的正常运行，防止数据库DOWN，然后才是为了提高性能

- 业务要保证正确

业务的正确保证不需要多言。所以为了避免插入重复数据时，DB需要设置唯一键（尽管这会降低DB性能）

- 性能优化是最后考虑的事

只有DB服务器正常运行，业务正确的前提下，再开始考虑优化性能

## 推荐方案

所以在***防止插入重复数据***时，推荐的方案是:

1. 使用redis作为接口锁，防止重复请求到达数据库，对数据库性能造成冲击（初步的幂等保证及数据库保护）
2. 使用唯一键保证不插入重复数据（最后的兜底及最终保证）

## 处理措施

1. 列出关键服务（交易，支付，清结算）的关键路径（接口）
2. 确认接口是否需要保证幂等，注明现在的幂等方案，考虑是否存在隐患
3. 第一步需要保证所有路径的`业务正确`，第二步使用推荐方案同时保证`业务正确`和`高性能`