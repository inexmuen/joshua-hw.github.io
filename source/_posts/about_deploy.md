---
title: 服务发布经验
date: 2016-12-01 20:00:00
author: Joshua
tags: devops
categories: devops
---

## 发布前

发布前的`checklist`需要包括以下内容

### 基础服务依赖

- `应用服务器`资源，`基础服务`资源(db/redis/rmq)需要提前申请。首次上线需要提前联系运维初始化机器
- MySql: 需要提前建库，建表，变更字段等
- Redis: 需要提前计算容量并确认
- rmq: 需要提前申请账号，确认`exchange`，`queue`等是否建立，是否需要提前bind

### SOA服务和接口依赖

- `依赖服务`的集群配置。需要估算请求`依赖服务`的QPS，和`依赖服务`owner确认调用集群，确认对方服务是否已经上线
- 需要提前发发布计划通知`调用方`和`被调用方`

### 上线服务本身配置

- `服务配置中心`上对应的配置是否已经设置
- 对应的`业务开关`/`灰度开关`是否在正确位置
- `发布系统`中对应的配置是否正确
- `集成测试`/`回归测试`是否正确无误

### 其他

- 至少需要一台生产环境机器登陆权限。有可能需要登陆服务器检查服务是否完全正常运行以及不正常运行的原因(日志收集服务有可能不太稳定，可能需要在生产环境进行一些操作和查询，***虽然这样不太合理***)

## 发布中

基本原则: ***所有的发布异常先恢复正常再修复发布问题***

发布中需要确认以下事情:

- 发布时间一般都是避开高峰期。紧急情况在高峰期发布是否可行
- 发布是否有先后顺序（服务依赖，接口依赖等）
- 发布时需要通知`NOC`，方便`NOC`进行监控和汇集，以便出现问题时知道大概这个时间点有哪些发布
- 发布时的灰度很重要
	- ***每个group至少应该有一台机器独立出来作为灰度机器***，每次发布先发这台机器并观察
	- 较大改动前先提前发`灰度机器`并观察一段时间
- 发布的合理步长(每次发布一个group里面的多少台机器)为一个group的1/8-1/4，保证发布平滑
- 发布时需要监控如下内容:
	- 对业务主流程是否有影响
	- 对其他服务是否有影响
	- 和本次发布相关的一些`技术指标`，`业务指标`等
- ***有异常第一时间回滚或者关闭功能开关，再查找原因(important)***。  

## 发布后

- 需要校验相关功能已经正确执行
- 回复对应发布邮件通知各相关方已经正确发布