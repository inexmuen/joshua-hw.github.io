---
title: RPC(远程过程调用)和MQ(消息队列)
date: 2017-01-23 12:00:00
author: Joshua
tags: arch
categories: arch
---

## 背景

系统间互相调用时，是选择RPC还是MQ是经常需要权衡的问题，本文对两者的特点及适用场合进行简单的分析。

## 系统结构

### RPC系统结构

```
+----------+     +----------+
| Consumer | <=> | Provider |
+----------+     +----------+

Consumer调用Provider提供的服务
```

### MQ系统结构

```
+----------+     +-------+     +----------+
| Producer | <=> | Queue | <=> | Consumer |
+----------+     +-------+     +----------+

Producer发送消息给Queue；Consumer从Queue拿消息来处理
```

## 功能特点

### 相同点

- 都利于大型系统的解耦
- 都是用于子系统的交互和通信，特别是异构子系统的交互

### RPC的特点

- 同步调用，是`本地调用`的扩展，对于要等待返回结果的场景，RPC是非常直觉的使用方式(当然RPC也可以是异步调用)
- 如果接口文件有变化，则Provider和Consumer都需要变更和重新部署

### MQ的特点

- MQ的请求和处理是异步的
- MQ能够把请求暂存在broker，可以起到请求`削峰`的作用，Consumer可以按照自己的节奏来处理请求
- MQ引入了一个新的结点(broker)，链路越长，系统的可靠性保障越低
- MQ侧重数据的传输，因此方式更加多样化，除了点对点外，还有订阅发布等功能

## 如何选择

- 如果希望同步得到请求的处理结果，则选用RPC；如果基于性能的考虑，比如服务端不能快速的响应客户端（或客户端也不要求实时响应），不希望请求端受限于处理端的处理速度时，则选用MQ
- RPC是本地调用的扩展，使用简单；MQ的异步编程模式比较复杂
- 可靠性上: RPC可以通过同步调用的结果来决定是否进行补偿等操作，MQ一般不认为100%可靠。
	- 对于有强一致性要求的场景，一般选择RPC
	- 对于为了增加主流程性能，让其他次要流程异步操作时，可以选择MQ，如短信发送，日志记录，邮件服务，通知服务等。
- 如果调用侧重于点对点的功能调用，则选用RPC；如果侧重于数据的传输和广播，则选用MQ

## 参考

- [The case: RPC vs. Messaging](https://sbdevel.wordpress.com/2009/12/17/the-case-rpc-vs-messaging/)