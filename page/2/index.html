<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Joshua">
<meta property="og:url" content="http://joshua-hw.github.io/page/2/index.html">
<meta property="og:site_name" content="Joshua">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joshua">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://joshua-hw.github.io/page/2/"/>





  <title> Joshua </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e5dae7bbccebdb4faa821c00a9cb4b55";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Joshua</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/11/28/idempotency/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/28/idempotency/" itemprop="url">
                  幂等的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-28T20:00:00+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/28/idempotency/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/28/idempotency/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/28/idempotency/" class="leancloud_visitors" data-flag-title="幂等的实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="关于幂等"><a href="#关于幂等" class="headerlink" title="关于幂等"></a>关于幂等</h2><p>幂等（idempotency）是一个数学与计算机学概念，常见于抽象代数中。在编程中，一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="1-查询操作"><a href="#1-查询操作" class="headerlink" title="1. 查询操作"></a>1. 查询操作</h3><p>查询一次和查询多次，在数据不变的情况下，查询结果是一样的。在隔离级别为可重复读时，select是天然的幂等操作 </p>
<h3 id="2-删除操作"><a href="#2-删除操作" class="headerlink" title="2. 删除操作"></a>2. 删除操作</h3><p>删除操作也是幂等的，删除一次和多次删除结果相同，都是把数据删除。(注意可能返回结果不一样，删除的数据不存在，返回0；删除的数据多条，返回结果多个) </p>
<h3 id="3-唯一索引，防止新增脏数据"><a href="#3-唯一索引，防止新增脏数据" class="headerlink" title="3. 唯一索引，防止新增脏数据"></a>3. 唯一索引，防止新增脏数据</h3><p>唯一索引或唯一组合索引来防止新增数据存在脏数据，不过对DB性能有影响</p>
<h3 id="4-token机制，防止页面重复提交"><a href="#4-token机制，防止页面重复提交" class="headerlink" title="4. token机制，防止页面重复提交"></a>4. token机制，防止页面重复提交</h3><p>处理流程：</p>
<ol>
<li>数据提交前要向服务的申请token，token放到redis或jvm内存，token设置有效时间</li>
<li>提交后后台校验token，同时删除token，生成新的token返回 </li>
</ol>
<p>token特点： </p>
<p>要申请，一次有效性，可以限流 </p>
<p>注意：redis要用删除操作来判断token，删除成功代表token校验通过，如果用select+delete来校验token，存在并发问题，不建议使用 </p>
<h3 id="5-悲观锁"><a href="#5-悲观锁" class="headerlink" title="5. 悲观锁"></a>5. 悲观锁</h3><p>获取数据的时候加锁获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from table_xxx where id=&apos;xxx&apos; for update;</div></pre></td></tr></table></figure>
<p>注意：id字段一定是主键或者唯一索引，不然是锁表，会死人的 </p>
<p>悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用 </p>
<h3 id="6-乐观锁"><a href="#6-乐观锁" class="headerlink" title="6. 乐观锁"></a>6. 乐观锁</h3><p>乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。 </p>
<p>乐观锁的实现方式多种多样可以通过version或者其他状态条件： </p>
<ul>
<li>通过版本号实现 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">update table_xxx set name=#name#,version=version+1 where version=#version#</div></pre></td></tr></table></figure>
<ul>
<li>通过条件限制 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">update table_xxx set avai_amount=avai_amount-#subAmount# where avai_amount-#subAmount# &gt;= 0</div></pre></td></tr></table></figure>
<p>要求：quality-#subQuality# &gt;= ，这个情景适合不用版本号，只更新是做数据安全校验，适合库存模型，扣份额和回滚份额，性能更高 </p>
<p>注意：乐观锁的更新操作，最好用主键或者唯一索引来更新,这样是行锁，否则更新时会锁表，上面两个sql改成下面的两个更好 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">update table_xxx set name=#name#,version=version+1 where id=#id# and version=#version# </div><div class="line">update table_xxx set avai_amount=avai_amount-#subAmount# where id=#id# and avai_amount-#subAmount# &gt;= 0</div></pre></td></tr></table></figure>
<h3 id="7-分布式锁"><a href="#7-分布式锁" class="headerlink" title="7. 分布式锁"></a>7. 分布式锁</h3><p>还是拿插入数据的例子，如果是分布式系统，构建全局唯一索引比较困难，例如唯一性的字段没法确定，这时候可以引入分布式锁，通过第三方的系统(redis或zookeeper)，在业务系统插入数据或者更新数据，获取分布式锁，然后做操作，之后释放锁，这样其实是把多线程并发的锁的思路，引入多多个系统，也就是分布式系统中的解决思路。</p>
<p>要点：某个长流程处理过程要求不能并发执行，可以在流程执行之前根据某个标志(用户ID+后缀等)获取分布式锁，其他流程执行时获取锁就会失败，也就是同一时间该流程只能有一个能执行成功，执行完成后，释放分布式锁(分布式锁要第三方系统提供) </p>
<h3 id="8-select-insert"><a href="#8-select-insert" class="headerlink" title="8. select + insert"></a>8. select + insert</h3><p>并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，在进行业务处理，就可以了</p>
<p>注意：核心高并发流程不要用这种方法 </p>
<h3 id="9-状态机幂等"><a href="#9-状态机幂等" class="headerlink" title="9. 状态机幂等"></a>9. 状态机幂等</h3><p>在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。 </p>
<p>注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助 </p>
<h3 id="10-对外提供接口的api如何保证幂等"><a href="#10-对外提供接口的api如何保证幂等" class="headerlink" title="10. 对外提供接口的api如何保证幂等"></a>10. 对外提供接口的api如何保证幂等</h3><p>如银联提供的付款接口：需要接入商户提交付款请求时附带：source来源，seq序列号<br>source+seq在数据库里面做唯一索引，防止多次付款，(并发时，只能处理一个请求) </p>
<p>重点：<br>对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源source，一个是来源方序列号seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。 </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/11/21/ops/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/ops/" itemprop="url">
                  运维之下
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-21T21:00:00+08:00">
                2016-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/21/ops/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/21/ops/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/21/ops/" class="leancloud_visitors" data-flag-title="运维之下">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230446.html" target="_blank" rel="external">《运维之下》——第一章：互联网运维工作</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230447.html" target="_blank" rel="external">《运维之下》——第二章：运维的烦恼</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230448.html" target="_blank" rel="external">《运维之下》——第三章：运维平台</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230449.html" target="_blank" rel="external">《运维之下》——第四章：服务器资源使用率</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230450.html" target="_blank" rel="external">《运维之下》——第五章：运维的未来</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230451.html" target="_blank" rel="external">《运维之下》——第六章：系统运维概述</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230452.html" target="_blank" rel="external">《运维之下》——第七章：资产管理</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230453.html" target="_blank" rel="external">《运维之下》——第八章：服务器硬件测试选型</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230454.html" target="_blank" rel="external">《运维之下》——第九章：网络成长之路</a></li>
<li><a href="http://www.voidcn.com/blog/wang_quan_li/article/p-6230455.html" target="_blank" rel="external">《运维之下》——第十章：传输网建设</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/11/14/interview/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/14/interview/" itemprop="url">
                  技术人员招聘指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-14T20:20:00+08:00">
                2016-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/management/" itemprop="url" rel="index">
                    <span itemprop="name">management</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/14/interview/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/14/interview/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/14/interview/" class="leancloud_visitors" data-flag-title="技术人员招聘指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要为平台交易支撑研发部技术人员的招聘提供一些建议及指南，主要包括面试的流程，内容及面试评定准则。</p>
<h2 id="一些原则"><a href="#一些原则" class="headerlink" title="一些原则"></a>一些原则</h2><ul>
<li>找出应聘者闪亮的地方<ul>
<li>技术上的亮点等</li>
</ul>
</li>
<li><code>如何获得知识</code> 比 <code>知道什么</code> 重要<ul>
<li>学习能力很重要</li>
</ul>
</li>
<li><code>基础知识</code> 比 <code>操作技能</code> 更重要<ul>
<li>扎实的理论比经验性的东西更重要，九层之台，起于累土 </li>
</ul>
</li>
<li>从一个简单的问题开始，从广度和深度上不断地跟进这个问题<ul>
<li>需要知道应聘者的能力边界在哪里</li>
</ul>
</li>
<li><code>思路和方法</code> 比 <code>答案</code> 更重要</li>
</ul>
<h2 id="简历筛选"><a href="#简历筛选" class="headerlink" title="简历筛选"></a>简历筛选</h2><p>需要从简历的内容上判断应聘者的<code>技术技能</code>,<code>项目经历</code>，<code>工作经历</code>是否和部门的需求相符。</p>
<p>具有以下特点的人可能会比较符合我们的要求:</p>
<ul>
<li>有大型/一线互联网公司工作经验的人</li>
<li>有电商/O2O公司工作经验的人</li>
<li>技术栈和我们比较匹配，或者能弥补部门技术短板的人</li>
</ul>
<h2 id="电话面试"><a href="#电话面试" class="headerlink" title="电话面试"></a>电话面试</h2><p>对于简历比较符合我们需求，但是没有条件进行当面面试的人，可以考虑先进行一轮电话面试。电话面试的主要目的在于<code>对应聘者有一个综合的了解，而不应扣细节</code>。可以: </p>
<ul>
<li>对应聘者简历中描述的内容进行一些确认</li>
<li>对应聘者简历中未提及的技术点进行一些询问以加强对应聘者技术能力的了解</li>
<li>对应聘者综合素质进行一些判定</li>
</ul>
<p>电话面试推荐不要超过两轮，并且需要在电话面试后确认是否需要约应聘者进行当面面试。</p>
<h2 id="面试内容"><a href="#面试内容" class="headerlink" title="面试内容"></a>面试内容</h2><p>以下是当面面试时的一些内容和一些参考问题，一面和二面可以分别从中抽取一些问题询问。<br>题目后面有标注题目的难度，分别对应P4,P5,P6级别(一些问题需要根据回答的深度区分p5/p6）</p>
<h3 id="基础及理论部分"><a href="#基础及理论部分" class="headerlink" title="基础及理论部分"></a>基础及理论部分</h3><ul>
<li>语言基础(python/java/c)<ul>
<li>python:<ul>
<li>元类的概念及使用(p5) </li>
<li>生成器，迭代器(p4)</li>
<li>环境管理(virtualenv,pip)(p4)</li>
<li>GIL产生的原因，对python并发的限制等(p5)</li>
<li>装饰器概念，使用场景，代码编写(p4)</li>
<li>monkey patch的使用(p5) </li>
<li>描述Python的垃圾回收机制(p5)<ul>
<li>引用计数</li>
<li>标记-清除机制</li>
<li>分代技术</li>
</ul>
</li>
</ul>
</li>
<li>java: collection, reflection, IOC, AOP, GC, classloader，Concurrency, generics, spring<ul>
<li>解释IoC和DI(p4),实现(p5) </li>
<li>内存分配: 栈，堆，静态区(p4) <ul>
<li>内存分配的原则</li>
<li>堆内存分块(p5)<ul>
<li>新生代</li>
<li>老年代</li>
<li>永久代  </li>
</ul>
</li>
</ul>
</li>
<li>Vector/ArrayList/LinkedList的区别(p4)</li>
<li>SpringBean的加载过程</li>
<li>AOP的实现(p5)</li>
<li>GC机制, MinorGC &amp; Full GC区别(p5), java内存泄漏场景(p5)</li>
<li>类加载机制(p5) </li>
<li>反射的使用(p5)</li>
<li>Thread Dump(p5)</li>
</ul>
</li>
<li>C: 指针，内存管理(p5)</li>
<li>编码能力<ul>
<li>Error和Exception的概念，使用姿势(p5) </li>
<li>序列化(p4)</li>
<li>wordcount程序</li>
<li>正则表达式相关(p4)</li>
<li>JIT概念，优点(p5)</li>
<li>编码解决生产者/消费者问题（p5）<ul>
<li>实现阻塞队列(p6) </li>
</ul>
</li>
<li>序列化和反序列化的作用，实现(p5)</li>
<li>死锁代码编写(p5)</li>
</ul>
</li>
<li>并发<ul>
<li>pid,ppid,pgid,sessionid含义(p5) </li>
<li>Thread的sleep和object的wait方法的区别(java)(p5) </li>
<li>线程安全(同步/锁机制)(p5)</li>
<li>ThreadLocal概念(p4)，使用(p5)，实现(p6) </li>
<li>协程(p5)</li>
<li>线程状态及转变(p4),线程池的使用(p5),线程池的设计(p6)</li>
<li>三个线程T1,T2,T3,怎样确保顺序执行(p5)<ul>
<li>join </li>
</ul>
</li>
<li>守护进/线程的含义，作用(p5)及实现(p6)<ul>
<li>守护进程 fork;父进程退出;子进程继续执行，成为init进程的子进程(p6)</li>
<li>进程/线程setDaemon作用，使用场景(p5)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>网络<ul>
<li>OSI网络模型(p4)</li>
<li>三次握手/四次挥手(p4)</li>
<li>http<ul>
<li>cookie/session(p4)</li>
<li>post/get/put/delete(p4)</li>
<li>restful(p5)</li>
<li>http/https区别(p4)</li>
</ul>
</li>
<li>cgi/fastcgi/wsgi/servlet作用，原理，区别(p5)</li>
<li>socket编程<ul>
<li>tcp echo server(p4),多线程/进程echo server(p5), 多路复用echo server(p6)</li>
</ul>
</li>
<li>进程间通信方式(p5)<ul>
<li>管道</li>
<li>信号</li>
<li>消息</li>
<li>共享内存</li>
<li>信号量</li>
<li>socket  </li>
</ul>
</li>
</ul>
</li>
<li>数据结构<ul>
<li>数组，链表，队列，栈，树，堆，图<ul>
<li>输出Fibonacci数列(p4)</li>
<li>队列/栈区别(p4) </li>
<li>如何判断链表是否有环(p5)</li>
<li>链表和数组的区别(存储，查找，删除等)(p4)</li>
<li>哈希冲突的处理方法（线性探测，二次哈希等，哈希算法）(p5)</li>
<li>交叉链表求交点(p5)</li>
<li>广度/深度优先遍历二叉树，前中后序遍历(p4) </li>
</ul>
</li>
</ul>
</li>
<li>操作系统<ul>
<li>IO模型 <ul>
<li>同步/异步，阻塞/非阻塞(p4)</li>
<li>select/poll/epoll区别,过程(p5) </li>
</ul>
</li>
<li>进程调度<ul>
<li>进程调度算法(先来先服务，短作业优先，最高优先权调度等)(p4)</li>
<li>僵尸进程/孤儿进程概念(p5) </li>
</ul>
</li>
<li>死锁的产生及避免(p5)</li>
<li>程序预处理，编译，汇编，链接过程/内容(p4)</li>
<li>静态链接/动态链接(p4)</li>
<li>内存的分页/分段(p4)</li>
<li>shell<ul>
<li>使用shell求uv/pv(p4) </li>
<li>查找所有包含’python’的进程并kill(p4)</li>
</ul>
</li>
</ul>
</li>
<li>设计模式<ul>
<li>代码实现单例模式 </li>
<li>MVC模式</li>
</ul>
</li>
<li>数据库<ul>
<li>ACID(p4)</li>
<li>脏读/不可重复读/幻读概念(p4)，场景(p5)</li>
<li>undo/redo log概念(p5), 作用原理(P6) </li>
<li>事务(p4)</li>
<li>乐观锁/悲观锁概念，使用(p5)，读/写锁，表/行锁 </li>
<li>sql注入(p4)</li>
<li>索引以及索引的实现(p5)</li>
<li>数据库操作的瓶颈及优化(p5) </li>
</ul>
</li>
<li>版本管理<ul>
<li>svn/git常用命令(p4)</li>
<li>git flow工作流(p4) </li>
</ul>
</li>
<li>算法<ul>
<li>各种排序算法描述/编码/时(空)间复杂度 <ul>
<li>插入，选择，归并，快速，堆，冒泡排序等(p5)</li>
</ul>
</li>
<li>查找算法<ul>
<li>二分查找，二叉树查找等(p4)  </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="项目及实践部分"><a href="#项目及实践部分" class="headerlink" title="项目及实践部分"></a>项目及实践部分</h3><ul>
<li>项目经验<ul>
<li>担任角色，项目内容，项目难点，项目优化等 </li>
<li>对于测试驱动开发的理解</li>
</ul>
</li>
<li>技能广度<ul>
<li>框架，中间件(db,cache,mq)，存储(关系型/NoSQL)</li>
<li>消息队列的使用场景</li>
</ul>
</li>
<li>技能深度<ul>
<li>源码，bug，坑</li>
<li>性能优化的经验描述</li>
</ul>
</li>
<li>Devops<ul>
<li>ci, docker</li>
<li>故障定位的经验: 过程及改进措施(p5)</li>
</ul>
</li>
<li>微服务 &amp; 架构<ul>
<li>幂等概念(p5)，实现(p6)</li>
<li>无状态含义</li>
<li>RPC框架设计(p6)</li>
<li>服务注册/配置(p5)</li>
<li>监控/trace/报警<ul>
<li>监控的设置(p5)</li>
<li>trace系统原理(p6) </li>
</ul>
</li>
<li>降级，限流，熔断，补偿，负载均衡，容量评估</li>
<li>微服务架构的分布式事务解决方案(p6)<ul>
<li>补偿型（TCC）</li>
<li>异步确保型（可靠消息最终一致）</li>
<li>最大努力通知型 </li>
</ul>
</li>
</ul>
</li>
<li>设计 <ul>
<li>开闭原则，MVP, KISS, Design For Failure，CAP(BASE)，DDD</li>
<li>什么是领域模型，什么是事务脚本？贫血模型/充血模型的区别(p6)</li>
<li>大型网站架构应该考虑的问题(p5)<ul>
<li>分层</li>
<li>分割</li>
<li>分布式</li>
<li>集群</li>
<li>缓存</li>
<li>异步</li>
<li>冗余  </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="综合部分"><a href="#综合部分" class="headerlink" title="综合部分"></a>综合部分</h3><p>主要考查应聘者的反应能力，学习能力，个人态度等</p>
<h2 id="面试评定"><a href="#面试评定" class="headerlink" title="面试评定"></a>面试评定</h2><p>面试完成后，面试官需要对应聘者给出评价，多个面试官沟通后需要给出结论是否通过，并给出对应的技术评级（参考<code>打怪升级指南</code>）。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://coolshell.cn/articles/1870.html" target="_blank" rel="external">我是怎么招聘程序员的</a></li>
<li><a href="http://coolshell.cn/articles/4506.html" target="_blank" rel="external">再谈“我是怎么招聘程序员的”（上）</a></li>
<li><a href="http://coolshell.cn/articles/4490.html" target="_blank" rel="external">再谈“我是怎么招聘程序员的”（下）</a></li>
<li><a href="ref/软件人员招聘.pdf">软件人员招聘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/11/12/how_to_design_a_language/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/12/how_to_design_a_language/" itemprop="url">
                  如何设计一门语言
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-12T22:30:00+08:00">
                2016-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/12/how_to_design_a_language/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/12/how_to_design_a_language/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/12/how_to_design_a_language/" class="leancloud_visitors" data-flag-title="如何设计一门语言">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="http://www.cppblog.com/vczh/archive/2013/04/27/199765.html" target="_blank" rel="external">如何设计一门语言（一）——什么是坑(a)</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/04/28/199805.html" target="_blank" rel="external">如何设计一门语言（二）——什么是坑(b)</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/05/05/199974.html" target="_blank" rel="external">如何设计一门语言（三）——什么是坑(面向对象和异常处理)</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/05/12/200195.html" target="_blank" rel="external">如何设计一门语言（四）——什么是坑(操作模板)</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/05/25/200580.html" target="_blank" rel="external">如何设计一门语言（五）——面向对象和消息发送</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/06/10/200920.html" target="_blank" rel="external">如何设计一门语言（六）——exception和error code</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/07/05/201541.html" target="_blank" rel="external">如何设计一门语言（七）——闭包、lambda和interface</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/07/27/202154.html" target="_blank" rel="external">如何设计一门语言（八）——异步编程和CPS变换</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/08/17/202605.html" target="_blank" rel="external">如何设计一门语言（九）——类型</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/09/16/203249.html" target="_blank" rel="external">如何设计一门语言（十）——正则表达式与领域特定语言（DSL）</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/10/19/203819.html" target="_blank" rel="external">如何设计一门语言（十一）——删减语言的功能</a></li>
<li><a href="http://www.cppblog.com/vczh/archive/2013/11/10/204189.html" target="_blank" rel="external">如何设计一门语言（十二）——设计可扩展的类型</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/11/02/disaster_recovery/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/02/disaster_recovery/" itemprop="url">
                  关于灾备
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-02T20:00:00+08:00">
                2016-11-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/02/disaster_recovery/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/02/disaster_recovery/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/02/disaster_recovery/" class="leancloud_visitors" data-flag-title="关于灾备">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="形式"><a href="#形式" class="headerlink" title="形式"></a>形式</h2><p>为了保证业务的高可用，需要保证关键业务做好灾备。</p>
<p>网站灾备方案不但承担容灾的任务，很多时候也承担着负载均衡，优化性能的任务。网站灾备有以下几种方式。</p>
<h3 id="主备镜像-冷备"><a href="#主备镜像-冷备" class="headerlink" title="主备镜像(冷备)"></a>主备镜像(冷备)</h3><p>两个数据中心服务器部署完全一样，每次网站发布都要在两个数据中心同时发布，保证运行系统版本一致。两个数据中心有主备之分，数据通过准实时的同步系统从主站不断同步到备站。主站发生灾害性故障导致完全不可用，则将域名解析切换到备站。这种方案纯粹是为了容灾。</p>
<h3 id="业务互补，数据同步"><a href="#业务互补，数据同步" class="headerlink" title="业务互补，数据同步"></a>业务互补，数据同步</h3><p>如某网站美国机房和国内机房部署的服务在业务上互补，美国机房部署买家服务，国内机房部署卖家服务，海外用户（主要是买家）访问美国机房，国内用户（主要是卖家）访问国内机房。主要业务数据互相实时同步，因为数据在两个机房同时写入，可能会发生冲突。</p>
<h3 id="主主镜像-多活"><a href="#主主镜像-多活" class="headerlink" title="主主镜像(多活)"></a>主主镜像(多活)</h3><p>部署和发布模式与主备一样，但是多个数据中心是同时启用的，根据用户地域将域名解析到不同的机房，数据实时同步。如新浪微博。</p>
<p>如北方用户访问北京机房，南方用户访问上海机房。主要业务数据互相实时同步。</p>
<h3 id="一写多读-类似于DB单master多slave"><a href="#一写多读-类似于DB单master多slave" class="headerlink" title="一写多读(类似于DB单master多slave)"></a>一写多读(类似于DB<code>单master多slave</code>)</h3><p>数据写入只发生在一个数据中心，但是为了加快地区用户访问，会将数据同步到其他数据中心供只读访问。这种方案适用于读多写少的网站。比如wikipedia。</p>
<hr>
<p>本文讨论<code>主备镜像</code>形式的灾备。</p>
<h2 id="流程-主备镜像"><a href="#流程-主备镜像" class="headerlink" title="流程(主备镜像)"></a>流程(主备镜像)</h2><p>灾备对应的流程如下:</p>
<p><img src="/2016/11/02/disaster_recovery/disaster_recovery.png" alt="disaster_recovery.png"></p>
<h2 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h2><h3 id="数据灾备"><a href="#数据灾备" class="headerlink" title="数据灾备"></a>数据灾备</h3><p>灾备的重点在于数据，即灾难发生后可以确保用户原有的数据不会丢失或者遭到破坏。解决方案是依赖基于网络的数据复制工具，实现生产中心和灾备中心之间的异步/同步的数据传输</p>
<p>数据灾备包括DB, rmq, cache的灾备</p>
<ul>
<li>DB的灾备依赖DB的主从复制实现</li>
<li>由于架构设计时rmq不建议使用在关键链路，并且应该提供对应的业务补偿，所以不考虑同步rmq的数据</li>
<li>关键链路中cache只允许使用作缓存，所以不需要考虑同步数据</li>
</ul>
<h3 id="应用灾备"><a href="#应用灾备" class="headerlink" title="应用灾备"></a>应用灾备</h3><p><code>应用灾备</code>是把应用处理能力再复制一份，也就是在异地灾备中心再构建一套支撑系统。<code>应用灾备</code>能提供应用接管能力，即在生产中心发生故障的情况下，能够在灾备中心接管应用，从而尽量减少系统停机时间，提高业务连续性。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul>
<li>由于应用灾备可能并未覆盖全路径，所以灾备环境调用未部署服务时需要做容错/降级处理</li>
<li>数据同步的技术多种多样，即可以基于存储阵列的复制软件实现，比如EMC MirrorView、H3C Replication等，也可以基于服务器或者应用软件实现，比如Veritas VVR、Oracle DataGuard等。但不管采用何种技术，都只是在不同的层面实现了数据的同步，要具备应用接管，还需要其他组件的配合，比如DNS域名切换解析、备用网络启用、应用服务切换等等。</li>
<li>cache未做数据同步时，在生产流量切换到灾备时，为了防止灾备所有流量打到DB，可能需要在流量切换前做cache预热</li>
<li>数据表冲突的防止。在做DB切换时，需要防止主键冲突，因此auto_increment的字段需要调整自增因子等</li>
<li>应用服务集群切换可以在服务注册中心处理</li>
<li>切换至冷备机器时，对于有状态的数据，需要在切换前修复数据状态；对于需要事件驱动状态向前的数据，需要复现事件或者手动推动状态向前。总而言之，要保证切换到灾备后，<strong><em>状态机(业务流程)在任何点中断时，系统能够推进状态机走到终态(important)</em></strong></li>
<li>需要考虑跨机房数据延时问题（以及由此造成的一系列数据问题），需要容忍数据丢失，并为数据延时考虑相应的对策</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/10/25/distributed-transaction-in-soa/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/25/distributed-transaction-in-soa/" itemprop="url">
                  微服务架构的分布式事务解决方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-25T15:00:00+08:00">
                2016-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/25/distributed-transaction-in-soa/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/25/distributed-transaction-in-soa/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/10/25/distributed-transaction-in-soa/" class="leancloud_visitors" data-flag-title="微服务架构的分布式事务解决方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="补偿型"><a href="#补偿型" class="headerlink" title="补偿型"></a>补偿型</h2><p><img src="/2016/10/25/distributed-transaction-in-soa/1_tcc.jpg" alt="tcc"></p>
<h2 id="异步确保型"><a href="#异步确保型" class="headerlink" title="异步确保型"></a>异步确保型</h2><p><img src="/2016/10/25/distributed-transaction-in-soa/2_mq.jpg" alt="mq"></p>
<h2 id="最大努力通知型"><a href="#最大努力通知型" class="headerlink" title="最大努力通知型"></a>最大努力通知型</h2><p><img src="/2016/10/25/distributed-transaction-in-soa/3_notice.jpg" alt="notice"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/10/10/delay_task/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/10/delay_task/" itemprop="url">
                  延时任务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-10T22:00:00+08:00">
                2016-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/10/delay_task/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/10/delay_task/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/10/10/delay_task/" class="leancloud_visitors" data-flag-title="延时任务">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>应用中都有延时任务的需求，需要任务在指定的时间之后执行，这里讨论一下延时任务的技术实现。</p>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p>实现方式主要有以下几种:</p>
<ul>
<li><code>rabbitmq + dead letter exchange</code>或者<code>rabbitmq + exchange plugin: x-delayed-message</code>。利用queue的<code>x-message-ttl</code>控制消息延时时间</li>
<li>DB轮询。将task存储在DB中，并设置task的执行时间，同时轮询DB取出当前需要执行的task执行。优点是可结合DB事务，缺点是可能存在单点问题</li>
<li>rabbitmq存储task，consumer延时处理。consumer端sleep N秒。当N较大时，mq中可能会堆积大量消息</li>
<li>使用beanstalkd, nsq等天生很好支持延时特性的queue，但是使用较少，社区缺少相应的技术支持</li>
</ul>
<h2 id="dead-letter-exchange"><a href="#dead-letter-exchange" class="headerlink" title="dead letter exchange"></a>dead letter exchange</h2><p>此处介绍一下DLX的创建, DLX的整体流程如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">delay_exchange =&gt; delay_queue =&gt; biz_exchange =&gt; biz_queue</div></pre></td></tr></table></figure>
<p>创建流程如下:</p>
<ul>
<li>创建延时exchange: <code>delay_exchange</code></li>
<li>创建延时queue: <code>delay_queue</code><ul>
<li>设置延迟时间: <code>x-message-ttl</code></li>
<li>设置消息到达expire时间后转到的exchange: <code>x-dead-letter-exchange</code>，需要为真正的业务exchange(<code>biz_exchange</code>)</li>
</ul>
</li>
<li>设置<code>delay_queue</code>和<code>delay_exchange</code>的绑定</li>
<li>创建业务exchange: <code>biz_exchange</code></li>
<li>创建业务queue: <code>biz_queue</code></li>
<li>设置<code>biz_exchange</code>和<code>biz_queue</code>的绑定</li>
</ul>
<p>此时发送到<code>delay_exchange</code>的消息，会在<code>x-message-ttl</code>设置的时间后，经过<code>delay_queue</code>转到<code>biz_exchange</code>，即到<code>biz_queue</code>里面。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/09/29/mq_back_up/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/29/mq_back_up/" itemprop="url">
                  消息补偿
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-29T20:00:00+08:00">
                2016-09-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/29/mq_back_up/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/29/mq_back_up/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/29/mq_back_up/" class="leancloud_visitors" data-flag-title="消息补偿">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Design-For-Failure"><a href="#Design-For-Failure" class="headerlink" title="Design For Failure"></a>Design For Failure</h2><p><code>Design For Failure</code>的核心思想在于: <strong><em>容忍错误，快速恢复，将failure当做普通事件处理</em></strong>。</p>
<p>当应用构建在云服务(cloud)上，这个概念更多被提及(<a href="http://www.slideshare.net/ashayc/design-for-failure-is-key-to-success-in-the-cloud" target="_blank" rel="external">Design For Failure Is Key To Success In The Cloud</a>)。因为相比普通线上环境，云设施的复杂度更大，同时也导致了稳定性以及健壮性的复杂，因此<code>Failure</code>在云环境需要被当做普通事件处理。最佳实践可参考<a href="http://techblog.netflix.com/2011/07/netflix-simian-army.html" target="_blank" rel="external">The Netflix Simian Army</a></p>
<p>同时对于正常环境，<code>Design For Failure</code>的设计思想在保证服务的健壮性，可用性上也大有裨益。</p>
<p>饿了么订单系统在<code>Design For Failure</code>思想上的实践主要有以下四个内容。第一是<code>消息广播补偿</code>，第二是<code>主流程补偿</code>，第三是<code>灾备</code>，第四是<code>随机故障测试系统</code>。</p>
<hr>
<p>本文详细介绍一下<code>消息广播补偿</code></p>
<h2 id="补偿方案"><a href="#补偿方案" class="headerlink" title="补偿方案"></a>补偿方案</h2><p>补偿方案可以考虑:</p>
<ul>
<li>不同介质的补偿，如mq/redis互相补偿</li>
<li>不同交互方式的补偿，如push/pull结合的补偿</li>
<li>失败操作的Retry补偿</li>
<li>记录操作状态，轮询失败状态补偿</li>
</ul>
<p>为了保证消息的高可用，将发送的消息同时存储到另外一种介质。出于性能和吞吐量上的考虑，此处考虑选择使用redis。rabbitmq发送消息时，同时保存对应routing_key的订单号到redis对应的zset中，并提供接口在rabbitmq异常时查询一定时间段内对应routing_key的订单号</p>
<p><img src="/2016/09/29/mq_back_up/mq_back_up.png" alt="mq_back_up.png"></p>
<h2 id="存储方案"><a href="#存储方案" class="headerlink" title="存储方案"></a>存储方案</h2><p>由于发送的消息均有一个routing_key(订单状态转变时发送对应routing_key的订单)，所以在存储时应该将消息以routing_key分类存放。考虑将order_id存储在以routing_key为key的zset中，同时以创建时间的时间戳作为zset的score，方便获取指定时间内的订单号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zadd(routing_key, int(time.time()), order_id)</div></pre></td></tr></table></figure>
<h2 id="容量计算"><a href="#容量计算" class="headerlink" title="容量计算"></a>容量计算</h2><p>由于每个订单的生命周期发出的消息平均约为5条，如订单的峰值TPS为1000，订单号为18位，需要提供查询半个小时之内的消息，根据解决方案可知需要至少存储1小时的内容，则需要的内存为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">3600 * 1000 * 18 * 5 / 1024 / 1024 = 309M</div></pre></td></tr></table></figure>
<h2 id="查询接口"><a href="#查询接口" class="headerlink" title="查询接口"></a>查询接口</h2><p>同时需要提供查询接口查询一段时间内对应routing_key的订单号，对应接口定义如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">map&lt;string, list&lt;i64&gt;&gt; get_mq_order_ids(1: list&lt;string&gt; routing_keys,</div><div class="line">                                        2: Timestamp from_datetime,</div><div class="line">                                        3: Timestamp to_datetime)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/09/21/load-testing-and-performance/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/21/load-testing-and-performance/" itemprop="url">
                  全链路性能测试 & 性能分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-21T17:00:00+08:00">
                2016-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/arch/" itemprop="url" rel="index">
                    <span itemprop="name">arch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/21/load-testing-and-performance/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/21/load-testing-and-performance/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/21/load-testing-and-performance/" class="leancloud_visitors" data-flag-title="全链路性能测试 & 性能分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Best Ref: <strong><em><a href="http://coolshell.cn/articles/7490.html" target="_blank" rel="external">性能调优攻略</a></em></strong></p>
<h2 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h2><h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p><code>性能测试</code>，是通过自动化的测试工具模拟多种正常、峰值以及异常负载条件来对系统的各项性能指标进行测试。区别于<code>压力测试</code>,在于压力测试要求进行超过规定性能指标的测试。</p>
<p>性能测试的目标为公司交易的主链路，包括<code>外卖平台</code>,<code>商户平台</code>,<code>开放平台</code>,<code>大物流</code>,<code>EOS订单业务</code>,<code>新支付</code>,<code>ERS餐厅业务</code>等。</p>
<h3 id="测试基本过程"><a href="#测试基本过程" class="headerlink" title="测试基本过程"></a>测试基本过程</h3><p>框架测试团队创建测试用户，测试餐厅，使用测试框架(jmeter)脚本模拟<code>用户下单</code>，<code>餐厅接单</code>，并且对中间<code>支付</code>，<code>物流</code>环节mock。从而对下单到配送的全链路进行性能测试。</p>
<p>性能测试和生产流程的差异如下:</p>
<ul>
<li>支付mock: 在调用支付的接口时，调用方使用特殊的merchant_id=101。测试团队mock支付调用的第三方服务，返回支付成功或者失败的结果。请求流程为 soa =&gt; payment =&gt; mock service(mock第三方支付服务)</li>
<li>物流特殊处理: 正常情况下，在订单确认之后，只要餐厅购买了配送服务，就会进入物流，不过物流加了一层控制，可以把这些订单过滤掉。目前平台有20k的餐厅，专门用来压测，这些压测订单的物流会忽略</li>
</ul>
<p>测试接口的调用，调用比率均通过分析对应服务集群的日志来确定。</p>
<h3 id="测试团队相关知识"><a href="#测试团队相关知识" class="headerlink" title="测试团队相关知识"></a>测试团队相关知识</h3><p><a href="http://wiki.ele.to:8090/pages/viewpage.action?pageId=20324754" target="_blank" rel="external">业务部门性能测试</a></p>
<h2 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h2><p>测试前，noc会进行以下操作: 开店</p>
<p>首页banner，皮肤，自动关店，hermes，base.hermes降级，支付mock开关打开</p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>测试过程中需要对业务相关指标进行监控，PTS主要包括以下业务</p>
<h3 id="zeus-eos"><a href="#zeus-eos" class="headerlink" title="zeus.eos"></a>zeus.eos</h3><p>需要注意以下指标:</p>
<ul>
<li><a href="https://t.elenet.me/dashboard/dashboard/db/eos-guan-jian-diao-yong-zhi-biao" target="_blank" rel="external">eos关键调用指标</a>, 主要用于监控主流程相关接口指标</li>
<li><a href="https://t.elenet.me/dashboard/dashboard/db/eos-xiang-guan-guan-jian-zhong-yao-zhi-biao" target="_blank" rel="external">eos相关关键指标</a>，主要用于监控cache，async task,txdaemon执行情况</li>
<li><a href="https://t.elenet.me/dashboard/dashboard/db/eos-jie-kou-zong-ti-zhi-biao" target="_blank" rel="external">eos接口总体指标</a>，主要用于对接口总体情况有一个大致的了解</li>
</ul>
<p>监控需要结合eos主流程来分析问题，EOS主流程如下:</p>
<p><strong><em>涉密不予提供</em></strong></p>
<p>同时需要了解EOS状态机各节点的含义和流转逻辑。</p>
<h3 id="osc-bacchus"><a href="#osc-bacchus" class="headerlink" title="osc.bacchus"></a>osc.bacchus</h3><p>订单催单/取消订单服务，对应监控面板: <a href="https://t.elenet.me/dashboard/dashboard/db/osc-bacchus" target="_blank" rel="external">osc.bacchus</a></p>
<p>主要关注自动取消订单(<code>hitcount(stats.apps.osc.bacchus.real_cancel_order, &#39;60s&#39;)</code>) 和 自动关店(<code>hitcount(stats.apps.osc.bacchus.real_close_restaurant, &#39;60s&#39;)</code>) 的指标</p>
<h3 id="osc-chronos"><a href="#osc-chronos" class="headerlink" title="osc.chronos"></a>osc.chronos</h3><p>准时达服务，对应监控面板: <a href="https://t.elenet.me/dashboard/dashboard/db/osc-chronos-zhun-shi-da-jian-kong-kan-ban" target="_blank" rel="external">osc.chronos</a></p>
<p>主要的关注目标chronos的队列消息情况，osc.chronos会有最大700k的unack量，其他两个队列是监听blink和eos的消息，可以查看是否有堆积。<br>另外可以关注chronos的机器负载情况，是否有负载过高的情形</p>
<h3 id="osc-blink"><a href="#osc-blink" class="headerlink" title="osc.blink"></a>osc.blink</h3><p>物流对接服务，对应监控面板: <a href="https://t.elenet.me/dashboard/dashboard/db/blink" target="_blank" rel="external">osc.blink</a></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="业务问题分析"><a href="#业务问题分析" class="headerlink" title="业务问题分析"></a>业务问题分析</h3><p>前提在于<strong>要对订单主流程熟悉</strong>。由于订单连接了<code>外卖平台</code>,<code>商户平台</code>,<code>大物流</code>,<code>支付</code>，所以当主流程(包括EOS和其他方)出现问题时，一般会反映在<a href="https://t.elenet.me/dashboard/dashboard/db/eos-guan-jian-diao-yong-zhi-biao?from=now-30m&amp;to=now&amp;panelId=43&amp;fullscreen" target="_blank" rel="external">订单实际状态扭转</a>上，可以据此并结合EOS自身的关键流程接口相关指标确认出问题的业务方。</p>
<h3 id="技术问题分析"><a href="#技术问题分析" class="headerlink" title="技术问题分析"></a>技术问题分析</h3><p>可以借助用来分析的工具包括<a href="https://t.elenet.me/dashboard/" target="_blank" rel="external">grafana</a>,<a href="http://etrace.elenet.me/" target="_blank" rel="external">etrace</a>,<a href="http://elk.elenet.me/" target="_blank" rel="external">elk</a>，特殊情况也可以直接登陆服务器通过log,分析工具htop,perf,tcpdump等进行分析</p>
<p>进行性能分析前，需要了解EOS的架构: <a href="http://wiki.ele.to:8090/pages/viewpage.action?pageId=26612648" target="_blank" rel="external">eos架构</a></p>
<p>基础服务指标监控如下:</p>
<ul>
<li>corvus &amp; redis</li>
</ul>
<p>redis监控地址: <a href="https://t.elenet.me/dashboard/dashboard/db/system-monitor-redis-cluster" target="_blank" rel="external">system-monitor-redis-cluster</a>，需要关注的指标包括<code>input</code>,<code>ops</code>,<code>slow commands</code>,<code>hit</code>,<code>miss</code>等</p>
<p>eos使用的redis包括:</p>
<pre><code>- zeus_eos_redis_cache:
    - 端口: 8604 
    - 作用: db_cache, patch_cache
- eos_zeus_redis_cache:
    - 端口: 8125 
    - 作用: api_cache
- eos_zeus_other_redis_cache:
    - 端口: 8147 
    - 作用: lock_param, rst_number_cache
</code></pre><p>由于redis的网络流程为: <code>client =&gt; goproxy =&gt; corvus</code>，redis的性能排查应该是从上往下逐级进行, corvus对应的监控地址为: <a href="https://t.elenet.me/dashboard/dashboard/db/esm-corvus-cluster?var-cluster=eos_zeus_other_redis_cache&amp;var-machine=xg-zeus-eos-redis-1&amp;from=now-30m&amp;to=now" target="_blank" rel="external">esm.corvus.cluster</a></p>
<ul>
<li>rmq</li>
</ul>
<p>rabbitmq监控地址: <a href="https://t.elenet.me/dashboard/dashboard/db/system-monitor-rabbitmq-queue" target="_blank" rel="external">system-monitor-rabbitmq-queue</a>，需要关注的指标包括ready, publish, ack情况等</p>
<ul>
<li>dal &amp; db</li>
</ul>
<p>dal和db的监控可以使用etrace，对应地址如下: <a href="http://etrace.elenet.me/main2.html#/dal/sql" target="_blank" rel="external">etrace dal</a> eos对应的group包括:</p>
<pre><code>- eos_mobile_eleme-zeus_eos_group
- eos_items_eleme-zeus_eos_group
- eos_eleme-zeus_eos_group
- eos_record_eleme-zeus_eos_group
</code></pre><p>同时DAL会关注dal相关指标:</p>
<p><a href="https://t.elenet.me/dashboard/dashboard/db/dalxing-neng-zhi-biao-xg?var-group=eos_eleme-zeus_eos_group&amp;var-group=login_eleme-biz_member_group" target="_blank" rel="external">dal性能指标</a></p>
<p>grafana切换到dal，对应的<a href="https://t.elenet.me/dashboard/dashboard/db/system-monitor" target="_blank" rel="external">dal-proxy服务器性能指标</a></p>
<p>DBA会关注对应的DB服务器性能指标，慢SQL，lock等</p>
<ul>
<li>应用服务器</li>
</ul>
<p>应用服务器的监控在: <a href="https://t.elenet.me/dashboard/dashboard/db/system-monitor-all" target="_blank" rel="external">system.monitor.all</a>，主要关注服务器的<code>CPU Util</code>,<code>Memory</code>,<code>Network</code>和<code>IO</code>等</p>
<p>EOS对应的集群分布为:</p>
<pre><code>- 外卖平台: sync-01, sync-02
- 新支付: sync-01
- 商户端: sync-03
- misc: sync-04
- 异步task: async
- script,txdaemon: cron
</code></pre><p>更详细的TCP监控在<a href="https://t.elenet.me/dashboard/dashboard/db/system-monitor-net-tcp?var-machine=qcr-zeus-eos-async-19&amp;var-machine=qcr-zeus-eos-async-20&amp;var-machine=qcr-zeus-eos-sync1-11&amp;var-machine=xg-dtcase-master-01&amp;from=now-12h&amp;to=now" target="_blank" rel="external">system.monitor.net.tcp</a>，可以在这里看tcp的连接情况</p>
<h4 id="性能分析的推荐步骤"><a href="#性能分析的推荐步骤" class="headerlink" title="性能分析的推荐步骤"></a>性能分析的推荐步骤</h4><p>性能分析的一般步骤为根据调用链路逐级住下，流程为: 接口 =&gt; 中间件 =&gt; 基础服务 =&gt; 操作系统</p>
<ul>
<li>接口性能分析时需要关注代码逻辑和接口依赖<ul>
<li>代码的性能分析可以参考: <strong><em><a href="http://coolshell.cn/articles/7490.html" target="_blank" rel="external">性能调优攻略</a></em></strong>，以下为Python的代码性能优化参考<ul>
<li>Python profile<ul>
<li><a href="https://segmentfault.com/a/1190000000616798" target="_blank" rel="external">Python 性能分析入门指南</a></li>
<li><a href="http://chenxiaoyu.org/2013/08/28/python-profile.html" target="_blank" rel="external">Python Profile 工具性能分析</a></li>
</ul>
</li>
<li>Python 火焰图<ul>
<li><a href="http://huoding.com/2016/08/18/531" target="_blank" rel="external">白话火焰图</a> </li>
<li><a href="http://xiaorui.cc/2015/10/22/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E4%B9%8B%E8%B0%83%E8%AF%95python%E5%BA%94%E7%94%A8%E7%94%9F%E6%88%90%E6%80%A7%E8%83%BDcpu%E7%81%AB%E7%84%B0%E5%9B%BE/" target="_blank" rel="external">开源项目之调试python应用生成性能cpu火焰图</a>    </li>
</ul>
</li>
</ul>
</li>
<li>接口依赖包括其他SOA服务依赖，基础服务依赖等，可以通过etrace观察调用链路分析瓶颈点</li>
</ul>
</li>
<li>中间件 和 基础服务 的性能主要通过对应的指标监控，观察对应的<code>cpu</code>,<code>memory</code>,<code>Network</code>,<code>IO</code>,<code>TCP</code>等</li>
<li>操作系统级别的性能分析可以参考<a href="http://www.brendangregg.com/linuxperf.html" target="_blank" rel="external">Linux Performance</a></li>
</ul>
<p><img src="/2016/09/21/load-testing-and-performance/linux_observability_tools.png" alt="linux_observability_tools"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://joshua-hw.github.io/2016/09/05/ab-testing/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="joshua">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Joshua">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Joshua" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/05/ab-testing/" itemprop="url">
                  AB Test
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-05T18:00:00+08:00">
                2016-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index">
                    <span itemprop="name">middleware</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/05/ab-testing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/05/ab-testing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/05/ab-testing/" class="leancloud_visitors" data-flag-title="AB Test">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="关于A-B测试"><a href="#关于A-B测试" class="headerlink" title="关于A/B测试"></a>关于A/B测试</h3><p>所谓A/B测试，简单来说，就是为同一个目标制定两个方案。让一部分流量使用A方案，另一部分流量使用B方案。并对比两个方案的最终运营数据，看哪个方案更符合设计目标。</p>
<p>A/B测试的大致流程如下:</p>
<p><img src="/2016/09/05/ab-testing/ABTesting.jpg" alt="ABTesting.jpg"></p>
<p>从图中可以看出A/B测试的四个关键角色:</p>
<ul>
<li>客户端(Client)</li>
<li>服务器(Server)</li>
<li>数据层(Data)</li>
<li>数据仓库(Data Warehouse)</li>
</ul>
<p>以及三种访问形式:</p>
<ul>
<li>无A/B测试的普通访问流程(Non AB test)</li>
<li>基于后端的A/B测试访问流程(Back-end AB test)</li>
<li>基于前端的A/B测试访问流程(Front-end AB test)</li>
</ul>
<h3 id="关键技术"><a href="#关键技术" class="headerlink" title="关键技术"></a>关键技术</h3><p>A/B Test的关键在于”分流”。从上图中我们可以看到，分流可以在客户端做，也可以在服务器端做。由于PTS部门项目均位于服务层，所以我们选择在SOA层(服务端)进行分流</p>
<h3 id="A-B-Testing-amp-灰度分布-amp-多变量测试"><a href="#A-B-Testing-amp-灰度分布-amp-多变量测试" class="headerlink" title="A/B Testing &amp; 灰度分布 &amp; 多变量测试"></a>A/B Testing &amp; 灰度分布 &amp; 多变量测试</h3><ul>
<li>AB test是一种灰度发布方式，比较注重两种方案之间的测试比较。重点是在几种方案中选择最优方案</li>
<li>灰度测试一般是在已有产品功能升级上的测试比较。是对某一产品的发布逐步扩大使用群体范围，也叫灰度放量</li>
<li>多变量测试(Multivariate Testing)，和A/B Test的区别在于多变量测试涉及到多种场景的比较，其中的变量有多个，而A/B Test通常只有一个变量。</li>
</ul>
<h2 id="功能模块设计及实现"><a href="#功能模块设计及实现" class="headerlink" title="功能模块设计及实现"></a>功能模块设计及实现</h2><h3 id="分流模块"><a href="#分流模块" class="headerlink" title="分流模块"></a>分流模块</h3><p>分流开始于<code>Dispatcher</code>(请求入口)，分流粒度为<code>接口级别</code>，使用装饰器将满足特定条件的请求</p>
<ul>
<li>从<code>被装饰的接口(A)</code>分流至<code>新的接口(B)</code></li>
<li>或者使用不同参数请求原接口</li>
</ul>
<p>工作流程如下:</p>
<p>请求 =&gt; 解析分流规则 =&gt; 分流</p>
<h3 id="规则管理模块"><a href="#规则管理模块" class="headerlink" title="规则管理模块"></a>规则管理模块</h3><p>用于对分流维度和规则进行管理和解析。</p>
<h4 id="分流维度"><a href="#分流维度" class="headerlink" title="分流维度"></a>分流维度</h4><ul>
<li>city_id</li>
<li>rst_id</li>
<li>user_id</li>
<li>order_id</li>
</ul>
<h4 id="分流规则"><a href="#分流规则" class="headerlink" title="分流规则"></a>分流规则</h4><ul>
<li>范围分流(range)</li>
<li>百分比分流(percent)</li>
<li>特定规则分流(based on split function)</li>
<li>特定值分流(huskar configs)</li>
</ul>
<h3 id="分流规则解析模块"><a href="#分流规则解析模块" class="headerlink" title="分流规则解析模块"></a>分流规则解析模块</h3><p>分流规则体现在装饰器的参数中。解析模块用于对分流规则进行解析，将符合条件的请求分流</p>
<h3 id="统计及展示模块"><a href="#统计及展示模块" class="headerlink" title="统计及展示模块"></a>统计及展示模块</h3><p>暂不考虑<code>统计模块</code>及<code>展示模块</code>的设计，运营数据的对比暂时由开发拉取数据进行分析（如果有需要的话，二期吧。。。） </p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><code>@split(func_name, func_get_element, rule, value, [*args, **kwargs])</code></p>
<ul>
<li>func_name: 分流函数名</li>
<li><p>func_get_element: 获取分流维度的函数</p>
<p>  分流维度可能包含以下方面:</p>
<ul>
<li>city_id</li>
<li>rst_id</li>
<li>user_id</li>
<li>order_id</li>
<li>order_mode</li>
<li>is_book</li>
<li><p>…</p>
<p>此处定义函数表示<code>如何从原接口参数中计算出分流的维度</code> </p>
</li>
</ul>
</li>
<li>rule: 分流规则<ul>
<li>range</li>
<li>percent</li>
<li>function</li>
<li>huskar</li>
</ul>
</li>
<li>value: 特定分流规则对应值，示例如下<ul>
<li>range: 1 - 100</li>
<li>percent: 20</li>
<li>function: 自定义function，返回值为True的请求将被分流</li>
<li>huskar: huskar配置中的值 </li>
</ul>
</li>
<li><code>*args, **kwargs</code>: 请求参数<ul>
<li>请求的新参数 </li>
</ul>
</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>A/B Test分流粒度为接口级别，分流结束后需要将流量导流至最终选择的接口</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/2180875?v=3&u=669f9a2b4e195cb7d1336a0dc4fa4efccaeba38c&s=400"
               alt="joshua" />
          <p class="site-author-name" itemprop="name">joshua</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">joshua</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"joshua-hw"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ya0eFUbLCIg0jjGECud9QRL1-gzGzoHsz", "C65sloIlf5l0jvchEvQ4MKV9");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
